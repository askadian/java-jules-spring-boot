name: Lightsail Deploy App

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Lightsail container service name'
        required: true
        default: 'library-container-service'
      container_name:
        description: 'Container name inside the service'
        required: true
        default: 'library-container'
      scale:
        description: 'Desired scale (number of container instances)'
        required: true
        default: '1'
      power:
        description: 'Container power (e.g. micro, small, medium, large)'
        required: true
        default: 'small'
      mysql_endpoint:
        description: 'MySQL endpoint (host only)'
        required: true
        default: 'ls-96b3fefee02576ef84032d9f27bacc50d3b646b4.cp8ouu8wuroj.us-east-1.rds.amazonaws.com'
      mysql_port:
        description: 'MySQL port'
        required: true
        default: '3306'
      mysql_user:
        description: 'MySQL username'
        required: true
        default: 'dbmasteruser'
      health_path:
        description: 'Health check path'
        required: true
        default: '/'
      health_success_codes:
        description: 'Health check success codes'
        required: true
        default: '200-499'
      health_interval:
        description: 'Health check interval seconds'
        required: true
        default: '5'
      health_timeout:
        description: 'Health check timeout seconds'
        required: true
        default: '2'
      health_healthy_threshold:
        description: 'Health check healthy threshold'
        required: true
        default: '2'
      health_unhealthy_threshold:
        description: 'Health check unhealthy threshold'
        required: true
        default: '2'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean install -f library-app/pom.xml

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Build and push Docker image to Amazon Lightsail
        id: build_and_push
        run: |
          set -e
          SERVICE_NAME="${{ github.event.inputs.service_name }}"
          CONTAINER_NAME="${{ github.event.inputs.container_name }}"
          aws lightsail push-container-image --service-name "${SERVICE_NAME}" --label "${CONTAINER_NAME}" --image "${CONTAINER_NAME}:latest" --dockerfile library-app/Dockerfile --path .
          IMAGE_REF=$(aws lightsail get-container-images --service-name "${SERVICE_NAME}" --query "containerImages[?contains(image,'.${CONTAINER_NAME}.')] | sort_by(@, &createdAt) | [-1].image" --output text)
          echo "IMAGE_REF=${IMAGE_REF}" >> $GITHUB_OUTPUT

      - name: Build deployment JSON files
        run: |
          set -e
          CONTAINER_NAME="${{ github.event.inputs.container_name }}"
          IMAGE="${{ steps.build_and_push.outputs.IMAGE_REF }}"
          MYSQL_ENDPOINT="${{ github.event.inputs.mysql_endpoint }}"
          MYSQL_PORT="${{ github.event.inputs.mysql_port }}"
          MYSQL_USER="${{ github.event.inputs.mysql_user }}"
          MYSQL_PASS="${{ secrets.MYSQL_PASSWORD }}"

          cat > containers.json <<EOF
          {
            "${CONTAINER_NAME}": {
              "image": "${IMAGE}",
              "ports": { "8080": "HTTP" },
              "environment": {
                "JDBC_DATABASE_URL": "jdbc:mysql://${MYSQL_ENDPOINT}:${MYSQL_PORT}/library?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC",
                "JDBC_DATABASE_USERNAME": "${MYSQL_USER}",
                "JDBC_DATABASE_PASSWORD": "${MYSQL_PASS}"
              }
            }
          }
          EOF

          cat > public-endpoint.json <<EOF
          {
            "containerName": "${CONTAINER_NAME}",
            "containerPort": 8080,
            "healthCheck": {
              "path": "${{ github.event.inputs.health_path }}",
              "successCodes": "${{ github.event.inputs.health_success_codes }}",
              "intervalSeconds": ${{ github.event.inputs.health_interval }},
              "timeoutSeconds": ${{ github.event.inputs.health_timeout }},
              "healthyThreshold": ${{ github.event.inputs.health_healthy_threshold }},
              "unhealthyThreshold": ${{ github.event.inputs.health_unhealthy_threshold }}
            }
          }
          EOF

      - name: Create service if missing and deploy
        run: |
          set -e
          SERVICE_NAME="${{ github.event.inputs.service_name }}"
          EXISTING=$(aws lightsail get-container-services --query "containerServices[?serviceName=='${SERVICE_NAME}'] | length(@)" --output text || echo "0")
          if [ "$EXISTING" = "0" ]; then
            echo "Creating service ${SERVICE_NAME} (power=${{ github.event.inputs.power }}, scale=${{ github.event.inputs.scale }})"
            aws lightsail create-container-service --service-name "${SERVICE_NAME}" --power "${{ github.event.inputs.power }}" --scale "${{ github.event.inputs.scale }}"
            sleep 10
          else
            echo "Service ${SERVICE_NAME} already exists"
          fi

          echo "Creating deployment..."
          aws lightsail create-container-service-deployment --service-name "${SERVICE_NAME}" --containers file://containers.json --public-endpoint file://public-endpoint.json

      - name: Show service status
        run: |
          SERVICE_NAME="${{ github.event.inputs.service_name }}"
          aws lightsail get-container-services --service-name "${SERVICE_NAME}" --output table
